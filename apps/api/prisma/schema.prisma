generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// TENANT (Bank)
// ============================================================

model Tenant {
  id             String   @id @default(uuid())
  name           String
  subdomain      String   @unique
  logoUrl        String?
  primaryColor   String?
  languageConfig Json     @default("{\"default\":\"fr\",\"available\":[\"fr\",\"ar\"]}")
  status         String   @default("active") // active | suspended | inactive
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Default Operating Hours (branches can override)
  defaultOpeningTime String? // "08:30" format (24h)
  defaultClosingTime String? // "16:30" format (24h)

  branches         Branch[]
  users            User[]
  serviceTemplates ServiceTemplate[]
  branchGroups     BranchGroup[]

  @@index([subdomain])
}

// ============================================================
// BRANCH
// ============================================================

model Branch {
  id               String    @id @default(uuid())
  tenantId         String
  tenant           Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name             String
  code             String
  address          String?
  region           String?
  timezone         String    @default("Africa/Tunis")
  notifyAtPosition Int       @default(2) // Notify when X patients away
  status           String    @default("active") // active | inactive
  queueStatus      String    @default("open") // open | paused | closed
  queuePausedAt    DateTime?
  queuePausedBy    String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Operating Hours (Auto Queue Management)
  autoQueueEnabled Boolean   @default(false) // Enable automatic open/close
  openingTime      String?   // "08:30" format (24h, branch timezone) - overrides tenant default
  closingTime      String?   // "16:30" format (24h, branch timezone) - overrides tenant default
  closedOnWeekends Boolean   @default(true)  // Skip auto-open on Sat/Sun

  counters         Counter[]
  services         ServiceCategory[]
  tickets          Ticket[]
  users            User[]
  dailyStats       DailyBranchStats[]
  hourlyStats      HourlySnapshot[]
  targets          BranchTarget[]
  announcements    Announcement[]
  groupMemberships BranchGroupMembership[]

  @@unique([tenantId, code])
  @@index([tenantId])
}

// ============================================================
// COUNTER (Guichet)
// ============================================================

model Counter {
  id              String   @id @default(uuid())
  branchId        String
  branch          Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  number          Int
  label           String?
  status          String   @default("closed") // open | closed | on_break
  currentTicketId String?  @unique
  assignedUserId  String?
  assignedUser    User?    @relation("AssignedCounter", fields: [assignedUserId], references: [id])
  activeBreakId   String?  @unique
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  assignedServices CounterService[]
  tickets          Ticket[]         @relation("ServedAtCounter")
  currentTicket    Ticket?          @relation("CurrentTicket", fields: [currentTicketId], references: [id])
  breaks           TellerBreak[]    @relation("CounterBreaks")
  activeBreak      TellerBreak?     @relation("ActiveBreak", fields: [activeBreakId], references: [id])

  @@unique([branchId, number])
  @@index([branchId])
  @@index([status])
}

// ============================================================
// SERVICE CATEGORY
// ============================================================

model ServiceCategory {
  id                      String           @id @default(uuid())
  branchId                String
  branch                  Branch           @relation(fields: [branchId], references: [id], onDelete: Cascade)
  sourceTemplateId        String?          // Link to parent template (null = manually created)
  sourceTemplate          ServiceTemplate? @relation(fields: [sourceTemplateId], references: [id])
  templateVersion         Int?             // Last synced template version
  overriddenFields        Json             @default("[]") // Identity fields locally overridden, e.g. ["nameFr","icon"]
  nameAr                  String
  nameFr                  String
  prefix                  String           // A, B, C... for ticket numbering
  icon                    String?
  priorityWeight          Int              @default(1)
  avgServiceTime          Int              @default(10) // minutes (manual setting)
  useAutomaticServiceTime Boolean          @default(false) // auto-calculate from last 24h
  isActive                Boolean          @default(true)
  displayOrder            Int              @default(0)    // Kiosk button display order
  showOnKiosk             Boolean          @default(true) // Hide from kiosk if false
  descriptionFr           String?          // Kiosk helper text (French)
  descriptionAr           String?          // Kiosk helper text (Arabic)
  serviceGroup            String?          // Kiosk grouping label
  subServicesFr           String[]         @default([]) // Sub-service labels shown on kiosk (French)
  subServicesAr           String[]         @default([]) // Sub-service labels shown on kiosk (Arabic)
  createdAt               DateTime         @default(now())
  updatedAt               DateTime         @updatedAt

  counters CounterService[]
  tickets  Ticket[]

  @@unique([branchId, prefix])
  @@index([branchId])
  @@index([sourceTemplateId])
}

// ============================================================
// SERVICE TEMPLATE (Bank-level reusable service definitions)
// ============================================================

model ServiceTemplate {
  id             String   @id @default(uuid())
  tenantId       String
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  nameAr         String
  nameFr         String
  prefix         String   // Suggested prefix (A, B, C...) - can be changed on copy
  icon           String?
  priorityWeight Int      @default(1)
  avgServiceTime Int      @default(10) // minutes
  isActive       Boolean  @default(true)
  version        Int      @default(1) // Increments on identity field changes
  descriptionFr  String?  // Kiosk helper text (French)
  descriptionAr  String?  // Kiosk helper text (Arabic)
  serviceGroup   String?  // Kiosk grouping label
  subServicesFr  String[] @default([]) // Sub-service labels shown on kiosk (French)
  subServicesAr  String[] @default([]) // Sub-service labels shown on kiosk (Arabic)
  displayOrder   Int      @default(0) // Suggested kiosk display order
  showOnKiosk    Boolean  @default(true) // Suggested kiosk visibility
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  linkedServices ServiceCategory[] // Branch services linked to this template

  @@unique([tenantId, nameFr]) // Prevent duplicate template names per tenant
  @@index([tenantId])
}

// ============================================================
// COUNTER-SERVICE JOIN TABLE
// ============================================================

model CounterService {
  counterId String
  counter   Counter         @relation(fields: [counterId], references: [id], onDelete: Cascade)
  serviceId String
  service   ServiceCategory @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  @@id([counterId, serviceId])
  @@index([serviceId])
}

// ============================================================
// TICKET
// ============================================================

model Ticket {
  id                  String    @id @default(uuid())
  branchId            String
  branch              Branch    @relation(fields: [branchId], references: [id], onDelete: Cascade)
  serviceCategoryId   String
  serviceCategory     ServiceCategory @relation(fields: [serviceCategoryId], references: [id])
  ticketNumber        String    // "A-042"
  status              String    @default("waiting") // waiting | called | serving | completed | no_show | cancelled
  priority            String    @default("normal") // normal | vip
  priorityReason      String?   // Reason for priority change (VIP, urgent, elderly, etc.)
  prioritizedBy       String?   // userId who prioritized
  prioritizedAt       DateTime? // When priority was changed
  customerPhone       String?
  notificationChannel String?   // none | sms | whatsapp
  checkinMethod       String    @default("kiosk") // kiosk | mobile | manual
  counterId           String?
  counter             Counter?  @relation("ServedAtCounter", fields: [counterId], references: [id])
  servedByUserId      String?
  servedBy            User?     @relation("ServedTickets", fields: [servedByUserId], references: [id])
  calledAt            DateTime?
  servingStartedAt    DateTime?
  completedAt         DateTime?
  notes               String?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relation for counter's current ticket
  currentAtCounter Counter? @relation("CurrentTicket")

  // Audit and notifications
  history       TicketHistory[]
  notifications NotificationLog[]

  @@index([branchId, status])
  @@index([branchId, createdAt])
  @@index([branchId, status, createdAt]) // Composite for call-next (FOR UPDATE SKIP LOCKED)
  @@index([serviceCategoryId, status])
  @@index([servedByUserId])
}

// ============================================================
// USER
// ============================================================

model User {
  id           String   @id @default(uuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branchId     String?
  branch       Branch?  @relation(fields: [branchId], references: [id])
  name         String
  email        String   @unique
  passwordHash String
  role         String   // super_admin | bank_admin | branch_manager | teller
  status       String   @default("active") // active | inactive
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  servedTickets   Ticket[]       @relation("ServedTickets")
  assignedCounter Counter[]      @relation("AssignedCounter")
  refreshTokens   RefreshToken[]
  ticketHistory   TicketHistory[]
  breaks          TellerBreak[]  @relation("UserBreaks")
  breaksStarted   TellerBreak[]  @relation("BreakStarter")
  breaksEnded     TellerBreak[]  @relation("BreakEnder")
  announcements   Announcement[]

  @@index([tenantId])
  @@index([branchId])
  @@index([email])
}

// ============================================================
// REFRESH TOKEN (Stateful Auth)
// ============================================================

model RefreshToken {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token      String   @unique
  deviceInfo String?
  expiresAt  DateTime
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// ============================================================
// TICKET HISTORY (Audit Log)
// ============================================================

model TicketHistory {
  id        String   @id @default(uuid())
  ticketId  String
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  action    String   // created | called | serving | completed | no_show | cancelled | transferred
  actorId   String?  // userId who performed action (null for system actions)
  actor     User?    @relation(fields: [actorId], references: [id])
  metadata  Json?    // additional context (e.g., transfer destination, counter info)
  createdAt DateTime @default(now())

  @@index([ticketId])
  @@index([ticketId, createdAt]) // Composite for history timeline queries
  @@index([actorId])
  @@index([createdAt])
}

// ============================================================
// NOTIFICATION LOG
// ============================================================

model NotificationLog {
  id              String    @id @default(uuid())
  ticketId        String
  ticket          Ticket    @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  channel         String    // sms | whatsapp
  messageType     String    // confirmation | almost_turn | your_turn
  recipient       String    // phone number
  providerId      String?   // Twilio message SID or Meta wamid
  provider        String?   // twilio | meta
  status          String    // queued | sent | delivered | read | failed
  deliveryStatus  String?   // sent | delivered | read | failed (Meta webhook updates)
  deliveredAt     DateTime?
  readAt          DateTime?
  cost            Decimal?  @db.Decimal(10, 4)
  errorMsg        String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([ticketId])
  @@index([status])
  @@index([createdAt])
  @@index([providerId])
}

// ============================================================
// DAILY BRANCH STATS (Pre-computed)
// ============================================================

model DailyBranchStats {
  id                 String   @id @default(uuid())
  branchId           String
  branch             Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  date               DateTime @db.Date
  totalTickets       Int      @default(0)
  completedTickets   Int      @default(0)
  noShows            Int      @default(0)
  avgWaitTimeMins    Int?
  avgServiceTimeMins Int?
  peakHour           Int?     // 0-23
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@unique([branchId, date])
  @@index([branchId])
  @@index([date])
}

// ============================================================
// HOURLY SNAPSHOT (For analytics)
// ============================================================

model HourlySnapshot {
  id              String   @id @default(uuid())
  branchId        String
  branch          Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  timestamp       DateTime
  hour            Int      // 0-23
  queueLength     Int      @default(0)
  activeCounters  Int      @default(0)
  avgWaitTimeMins Int?
  createdAt       DateTime @default(now())

  @@index([branchId, timestamp])
  @@index([branchId, hour])
}

// ============================================================
// TELLER BREAK (Pause Tracking)
// ============================================================

model TellerBreak {
  id           String    @id @default(uuid())
  counterId    String
  counter      Counter   @relation("CounterBreaks", fields: [counterId], references: [id], onDelete: Cascade)
  userId       String
  user         User      @relation("UserBreaks", fields: [userId], references: [id])
  branchId     String

  reason       String    // lunch | prayer | personal | urgent
  durationMins Int       // planned duration in minutes
  startedAt    DateTime  @default(now())
  expectedEnd  DateTime  // calculated: startedAt + durationMins
  actualEnd    DateTime? // null until break ends

  startedById  String    // userId who initiated (BM or self)
  startedBy    User      @relation("BreakStarter", fields: [startedById], references: [id])
  endedById    String?   // userId who ended break
  endedBy      User?     @relation("BreakEnder", fields: [endedById], references: [id])

  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relation for active break
  activeAtCounter Counter? @relation("ActiveBreak")

  @@index([counterId])
  @@index([branchId, startedAt])
  @@index([userId])
}

// ============================================================
// BRANCH TARGET (Daily Goals)
// ============================================================

model BranchTarget {
  id            String   @id @default(uuid())
  branchId      String
  branch        Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  date          DateTime @db.Date
  servedTarget  Int      @default(100)  // Daily served target
  avgWaitTarget Int      @default(10)   // Target avg wait (minutes)
  slaTarget     Int      @default(90)   // SLA percentage target
  slaThreshold  Int      @default(15)   // Minutes for SLA calculation
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([branchId, date])
  @@index([branchId])
}

// ============================================================
// ANNOUNCEMENT (Broadcast messages to TV displays)
// ============================================================

model Announcement {
  id              String    @id @default(uuid())
  branchId        String
  branch          Branch    @relation(fields: [branchId], references: [id], onDelete: Cascade)
  message         String    // Max 200 chars - message in French
  messageAr       String?   // Optional Arabic version
  priority        String    @default("normal") // normal | urgent
  enableTts       Boolean   @default(false) // Text-to-speech
  displayDuration Int       @default(30) // seconds to display
  createdBy       String
  creator         User      @relation(fields: [createdBy], references: [id])
  dismissedBy     String?
  dismissedAt     DateTime?
  expiresAt       DateTime?
  createdAt       DateTime  @default(now())

  @@index([branchId, createdAt])
}

// ============================================================
// BRANCH GROUP (Logical grouping for bulk operations)
// ============================================================

model BranchGroup {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  memberships BranchGroupMembership[]

  @@unique([tenantId, name])
  @@index([tenantId])
}

// ============================================================
// BRANCH GROUP MEMBERSHIP (Join table)
// ============================================================

model BranchGroupMembership {
  branchGroupId String
  branchGroup   BranchGroup @relation(fields: [branchGroupId], references: [id], onDelete: Cascade)
  branchId      String
  branch        Branch      @relation(fields: [branchId], references: [id], onDelete: Cascade)

  @@id([branchGroupId, branchId])
  @@index([branchId])
}

// ============================================================
// SERVICE CHANGE LOG (Audit trail for templates & services)
// ============================================================

model ServiceChangeLog {
  id         String   @id @default(uuid())
  entityType String   // 'template' | 'service'
  entityId   String
  action     String   // 'create' | 'update' | 'delete' | 'sync' | 'deploy'
  field      String?  // Specific field changed (null for create/delete/deploy)
  oldValue   String?
  newValue   String?
  changedBy  String   // userId
  metadata   Json?    // Extra context (e.g., branchId for deploy, sync details)
  createdAt  DateTime @default(now())

  @@index([entityType, entityId])
  @@index([changedBy])
  @@index([createdAt])
}
